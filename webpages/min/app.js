!function(){const e="/api/logging/level",t="/api/logging/start",n="/api/logging/stop",o="/api/logging/download",a="/api/logout",s="/api/login",i=(e,t=document)=>t.querySelector(e),l=(e,t=document)=>Array.from(t.querySelectorAll(e)),c=(e,t="info")=>{const n=i("#toast");n&&(n.textContent=e,n.className=`toast show ${t}`,setTimeout((()=>n.classList.remove("show")),2200))},d=async(e,t={})=>{try{const n=await fetch(e,t);if(!n.ok)throw new Error(n.status+" "+n.statusText);return n}catch(t){return console.warn("API fallback (demo):",e,t.message),{ok:!0,json:async()=>({ok:!0}),blob:async()=>new Blob}}};function r(){const e=i(".sidebar"),t=i(".content");e&&(e.style.display="none"),t&&(t.style.display="none");let n=i("#login-mount");n||(n=document.createElement("div"),n.id="login-mount",document.body.appendChild(n)),n.hidden=!1,n.innerHTML='\n      <div class="login-wrap">\n        <div class="login-card">\n          <h1>Đăng nhập</h1>\n          <div class="field">\n            <label>Username</label>\n            <input id="login-u" type="text" placeholder="admin" />\n          </div>\n          <div class="field">\n            <label>Password</label>\n            <input id="login-p" type="password" placeholder="••••••••" />\n          </div>\n          <div class="actions">\n            <button class="btn" id="btnLogin">Login</button>\n          </div>\n          <p id="login-msg" class="login-msg"></p>\n        </div>\n      </div>\n    ',i("#btnLogin").addEventListener("click",(async()=>{const e=i("#login-u").value.trim(),t=i("#login-p").value;e&&t?(await d(s,{method:"POST",body:JSON.stringify({u:e,p:t})}),localStorage.setItem("token","dummy"),location.hash="#/home",n.hidden=!0,g()):i("#login-msg").textContent="Vui lòng nhập đủ thông tin"}))}function g(){const s=i(".sidebar"),g=i(".content");s&&(s.style.display=""),g&&(g.style.display="");const u=i("#login-mount");u&&(u.hidden=!0),function(){const e=i("#btnLogout");if(!e)return;e.replaceWith(e.cloneNode(!0));const t=i("#btnLogout");t.addEventListener("click",(async()=>{try{t.disabled=!0,t.classList.add("loading")}catch{}try{await fetch(a,{method:"POST"})}catch{}try{localStorage.clear(),sessionStorage.clear()}catch{}location.hash="#/login",r()}))}(),function(){const e=l(".sidebar-btn"),t=l(".settings-section");if(!e.length||!t.length)return;e.forEach((e=>{e.replaceWith(e.cloneNode(!0))}));const n=l(".sidebar-btn");n.forEach((e=>{e.addEventListener("click",(function(){n.forEach((e=>e.classList.remove("active"))),this.classList.add("active"),t.forEach((e=>e.style.display="none"));const e=this.dataset.section,o=document.getElementById(e);o&&(o.style.display="")}))}))}(),function(){const a=i("#levelSelect"),s=i("#levelDisplay"),l=i("#btnStart"),r=i("#btnStop"),g=i("#btnSave"),u=i("#logPreview");if(!(a&&l&&r&&g))return;a.replaceWith(a.cloneNode(!0)),l.replaceWith(l.cloneNode(!0)),r.replaceWith(r.cloneNode(!0)),g.replaceWith(g.cloneNode(!0));const h=i("#levelSelect"),b=i("#btnStart"),p=i("#btnStop"),m=i("#btnSave");let v=!1,y=null,f=[];const L=e=>{const t=`[${(new Date).toISOString()}] [${s.textContent.trim()}] ${e}`;f.push(t),f.length>500&&f.shift(),u.textContent=f.slice(-20).join("\n")};h.addEventListener("change",(async()=>{const t=h.value;s.textContent=t,L(`Logging level set to ${t}`);const n=await d(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({level:t})});c(n.ok?"Set level OK":"Set level failed",n.ok?"success":"error")})),b.addEventListener("click",(async()=>{if(v)return;b.disabled=!0,b.classList.add("loading");const e=await d(t,{method:"POST"});if(b.classList.remove("loading"),!e.ok)return b.disabled=!1,void c("Start failed","error");v=!0,p.disabled=!1,p.classList.remove("btn-muted"),L("Start logging to debug.log"),y=setInterval((()=>L("IP camera heartbeat")),1500),c("Logging started","success")})),p.addEventListener("click",(async()=>{if(!v)return;p.classList.add("loading");const e=await d(n,{method:"POST"});p.classList.remove("loading"),e.ok?(v=!1,b.disabled=!1,p.disabled=!0,p.classList.add("btn-muted"),y&&clearInterval(y),L("Stop logging to debug.log"),c("Logging stopped","success")):c("Stop failed","error")})),m.addEventListener("click",(async()=>{try{const e=await d(o);if(!e||!e.blob||e instanceof Response){const t=await e.blob(),n=URL.createObjectURL(t),o=Object.assign(document.createElement("a"),{href:n,download:"debug.log"});document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(n)}else{const e=new Blob([f.join("\n")],{type:"text/plain;charset=utf-8"}),t=URL.createObjectURL(e),n=Object.assign(document.createElement("a"),{href:t,download:"debug.log"});document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(t)}c("Log saved","success")}catch{c("Save failed","error")}}))}()}function u(){localStorage.getItem("token")&&"#/login"!==location.hash?g():r()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u):u(),window.addEventListener("hashchange",u)}();